<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migration Visual Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .version-frame {
            flex: 1;
            border: 2px solid #16213e;
            border-radius: 8px;
            padding: 10px;
        }
        .version-frame h3 {
            margin: 0 0 10px 0;
            color: #00d2ff;
        }
        iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #333;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            background: #16213e;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        button {
            background: #00d2ff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #00b8e6;
        }
        .results {
            margin: 20px 0;
            padding: 15px;
            background: #16213e;
            border-radius: 8px;
        }
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .screenshot {
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <h1>üîÑ Migration Visual Testing</h1>
    <p>Compare visual output between monolithic and modular versions</p>

    <div class="controls">
        <h3>Test Controls</h3>
        <button onclick="loadBothVersions()">üì± Load Both Versions</button>
        <button onclick="runVisualTest()">üì∏ Capture Screenshots</button>
        <button onclick="compareVersions()">‚öñÔ∏è Compare Versions</button>
        <button onclick="downloadResults()">üíæ Download Results</button>
    </div>

    <div class="test-container">
        <div class="version-frame">
            <h3>üóÇÔ∏è Monolithic Version (index.html)</h3>
            <div class="status" id="monolithic-status">Not loaded</div>
            <iframe id="monolithic-frame" src="about:blank"></iframe>
        </div>
        
        <div class="version-frame">
            <h3>üèóÔ∏è Modular Version (src/index.html)</h3>
            <div class="status" id="modular-status">Not loaded</div>
            <iframe id="modular-frame" src="about:blank"></iframe>
        </div>
    </div>

    <div class="results" id="results">
        <h3>Test Results</h3>
        <p>Click "Capture Screenshots" to begin visual comparison</p>
        <div class="comparison" id="comparison"></div>
    </div>

    <script>
        let testResults = {
            monolithic: {},
            modular: {},
            comparison: {}
        };

        function updateStatus(version, message) {
            document.getElementById(`${version}-status`).textContent = message;
        }

        function loadBothVersions() {
            console.log('üîÑ Loading both versions...');
            
            // Load monolithic version
            const monolithicFrame = document.getElementById('monolithic-frame');
            monolithicFrame.src = './index.html';
            updateStatus('monolithic', 'Loading...');
            
            monolithicFrame.onload = () => {
                updateStatus('monolithic', 'Loaded ‚úÖ');
                console.log('‚úÖ Monolithic version loaded');
            };
            
            monolithicFrame.onerror = () => {
                updateStatus('monolithic', 'Failed to load ‚ùå');
                console.error('‚ùå Failed to load monolithic version');
            };

            // Load modular version  
            const modularFrame = document.getElementById('modular-frame');
            modularFrame.src = './src/index.html';
            updateStatus('modular', 'Loading...');
            
            modularFrame.onload = () => {
                updateStatus('modular', 'Loaded ‚úÖ');
                console.log('‚úÖ Modular version loaded');
            };
            
            modularFrame.onerror = () => {
                updateStatus('modular', 'Failed to load ‚ùå');
                console.error('‚ùå Failed to load modular version');
            };
        }

        async function captureFrameCanvas(frameId) {
            return new Promise((resolve, reject) => {
                try {
                    const frame = document.getElementById(frameId);
                    const canvas = frame.contentDocument?.getElementById('gameCanvas');
                    
                    if (!canvas) {
                        reject(new Error(`No canvas found in ${frameId}`));
                        return;
                    }

                    // Create a new canvas to copy the game canvas
                    const copyCanvas = document.createElement('canvas');
                    copyCanvas.width = canvas.width;
                    copyCanvas.height = canvas.height;
                    const copyCtx = copyCanvas.getContext('2d');
                    
                    // Copy the canvas content
                    copyCtx.drawImage(canvas, 0, 0);
                    
                    // Get image data
                    const dataURL = copyCanvas.toDataURL('image/png');
                    const imageData = copyCtx.getImageData(0, 0, canvas.width, canvas.height);
                    
                    resolve({
                        dataURL,
                        imageData,
                        width: canvas.width,
                        height: canvas.height,
                        timestamp: Date.now()
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function runVisualTest() {
            console.log('üì∏ Starting visual test...');
            updateResults('Running visual tests...');

            try {
                // Wait a moment for games to load
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Capture monolithic version
                updateResults('Capturing monolithic version...');
                try {
                    testResults.monolithic = await captureFrameCanvas('monolithic-frame');
                    console.log('‚úÖ Captured monolithic screenshot');
                } catch (error) {
                    console.error('‚ùå Failed to capture monolithic:', error);
                    testResults.monolithic = { error: error.message };
                }

                // Capture modular version
                updateResults('Capturing modular version...');
                try {
                    testResults.modular = await captureFrameCanvas('modular-frame');
                    console.log('‚úÖ Captured modular screenshot');
                } catch (error) {
                    console.error('‚ùå Failed to capture modular:', error);
                    testResults.modular = { error: error.message };
                }

                // Display results
                displayCaptures();
                compareVersions();

            } catch (error) {
                console.error('‚ùå Visual test failed:', error);
                updateResults(`Test failed: ${error.message}`);
            }
        }

        function displayCaptures() {
            const comparison = document.getElementById('comparison');
            comparison.innerHTML = '';

            // Monolithic screenshot
            if (testResults.monolithic.dataURL) {
                const monolithicDiv = document.createElement('div');
                monolithicDiv.className = 'screenshot';
                monolithicDiv.innerHTML = `
                    <h4>Monolithic Version</h4>
                    <img src="${testResults.monolithic.dataURL}" style="max-width: 100%; height: auto;" alt="Monolithic Screenshot">
                    <p>Size: ${testResults.monolithic.width}x${testResults.monolithic.height}</p>
                `;
                comparison.appendChild(monolithicDiv);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'screenshot';
                errorDiv.innerHTML = `<h4>Monolithic Version</h4><p>‚ùå ${testResults.monolithic.error || 'Capture failed'}</p>`;
                comparison.appendChild(errorDiv);
            }

            // Modular screenshot
            if (testResults.modular.dataURL) {
                const modularDiv = document.createElement('div');
                modularDiv.className = 'screenshot';
                modularDiv.innerHTML = `
                    <h4>Modular Version</h4>
                    <img src="${testResults.modular.dataURL}" style="max-width: 100%; height: auto;" alt="Modular Screenshot">
                    <p>Size: ${testResults.modular.width}x${testResults.modular.height}</p>
                `;
                comparison.appendChild(modularDiv);
            } else {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'screenshot';
                errorDiv.innerHTML = `<h4>Modular Version</h4><p>‚ùå ${testResults.modular.error || 'Capture failed'}</p>`;
                comparison.appendChild(errorDiv);
            }
        }

        function compareVersions() {
            if (!testResults.monolithic.imageData || !testResults.modular.imageData) {
                updateResults('‚ö†Ô∏è Cannot compare - missing image data');
                return;
            }

            const mono = testResults.monolithic.imageData;
            const mod = testResults.modular.imageData;

            if (mono.width !== mod.width || mono.height !== mod.height) {
                testResults.comparison = {
                    match: false,
                    reason: 'Different canvas sizes',
                    monolithicSize: `${mono.width}x${mono.height}`,
                    modularSize: `${mod.width}x${mod.height}`
                };
            } else {
                // Simple pixel comparison
                let differentPixels = 0;
                const totalPixels = mono.width * mono.height;
                
                for (let i = 0; i < mono.data.length; i += 4) {
                    const rDiff = Math.abs(mono.data[i] - mod.data[i]);
                    const gDiff = Math.abs(mono.data[i + 1] - mod.data[i + 1]);
                    const bDiff = Math.abs(mono.data[i + 2] - mod.data[i + 2]);
                    const aDiff = Math.abs(mono.data[i + 3] - mod.data[i + 3]);
                    
                    if (rDiff > 5 || gDiff > 5 || bDiff > 5 || aDiff > 5) {
                        differentPixels++;
                    }
                }

                const similarity = ((totalPixels - differentPixels) / totalPixels) * 100;
                
                testResults.comparison = {
                    match: similarity > 95,
                    similarity: similarity.toFixed(2),
                    differentPixels,
                    totalPixels,
                    threshold: '95%'
                };
            }

            displayComparison();
        }

        function displayComparison() {
            const comp = testResults.comparison;
            let resultHTML = '<h3>üìä Comparison Results</h3>';
            
            if (comp.reason) {
                resultHTML += `<p>‚ùå ${comp.reason}</p>`;
                resultHTML += `<p>Monolithic: ${comp.monolithicSize}, Modular: ${comp.modularSize}</p>`;
            } else if (comp.match) {
                resultHTML += `<p>‚úÖ Visual match! Similarity: ${comp.similarity}%</p>`;
                resultHTML += `<p>Threshold: ${comp.threshold}</p>`;
            } else {
                resultHTML += `<p>‚ö†Ô∏è Visual differences detected</p>`;
                resultHTML += `<p>Similarity: ${comp.similarity}% (threshold: ${comp.threshold})</p>`;
                resultHTML += `<p>Different pixels: ${comp.differentPixels.toLocaleString()} / ${comp.totalPixels.toLocaleString()}</p>`;
            }

            updateResults(resultHTML);
        }

        function updateResults(content) {
            document.getElementById('results').innerHTML = `
                <h3>Test Results</h3>
                <div>${content}</div>
            `;
        }

        function downloadResults() {
            const results = {
                timestamp: new Date().toISOString(),
                migration_test: 'visual_comparison',
                versions: {
                    monolithic: {
                        captured: !!testResults.monolithic.dataURL,
                        size: testResults.monolithic.width ? 
                            `${testResults.monolithic.width}x${testResults.monolithic.height}` : null,
                        error: testResults.monolithic.error || null
                    },
                    modular: {
                        captured: !!testResults.modular.dataURL,
                        size: testResults.modular.width ? 
                            `${testResults.modular.width}x${testResults.modular.height}` : null,
                        error: testResults.modular.error || null
                    }
                },
                comparison: testResults.comparison,
                summary: {
                    visual_parity: testResults.comparison.match || false,
                    similarity: testResults.comparison.similarity || 'N/A',
                    migration_status: 'Phase 1 Complete'
                }
            };

            const blob = new Blob([JSON.stringify(results, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `migration_visual_test_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('üì• Downloaded visual test results');
        }

        // Auto-load on page ready
        window.addEventListener('load', () => {
            console.log('üéÆ Migration Visual Test Ready');
            console.log('Click "Load Both Versions" to begin');
        });
    </script>
</body>
</html>