<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Responsiveness Test - US-004</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: monospace;
            background: #1a1a2e;
            color: #eee;
            text-align: center;
        }
        canvas {
            border: 2px solid #4ecdc4;
            background: #2a2a3e;
            display: block;
            margin: 20px auto;
        }
        .info {
            background: #333;
            padding: 15px;
            border-radius: 8px;
            max-width: 800px;
            margin: 0 auto 20px auto;
            text-align: left;
        }
        .status {
            background: #0f3460;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: rgba(40, 167, 69, 0.3); }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .control-group {
            background: #333;
            padding: 10px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>üéØ Input Responsiveness Test - US-004</h1>
    <div class="info">
        <p><strong>Test:</strong> Verify InputManager provides responsive, lag-free input identical to monolithic version</p>
        <p><strong>Character:</strong> Orange rectangle that moves with your input</p>
        <p><strong>Success Criteria:</strong> Immediate response, smooth movement, no input lag or dropped inputs</p>
    </div>

    <div id="status" class="status">Initializing InputManager...</div>
    <canvas id="testCanvas" width="800" height="400"></canvas>

    <div class="controls">
        <div class="control-group">
            <h4>Movement</h4>
            <p><kbd>A</kbd> / <kbd>‚Üê</kbd> - Move Left</p>
            <p><kbd>D</kbd> / <kbd>‚Üí</kbd> - Move Right</p>
        </div>
        <div class="control-group">
            <h4>Actions</h4>
            <p><kbd>W</kbd> / <kbd>Space</kbd> / <kbd>‚Üë</kbd> - Jump</p>
            <p><kbd>S</kbd> / <kbd>‚Üì</kbd> - Crouch</p>
        </div>
        <div class="control-group">
            <h4>Mobile</h4>
            <p>Touch controls automatically enabled on mobile devices</p>
        </div>
    </div>

    <div id="debugInfo" class="info" style="display: none;">
        <h4>Debug Information:</h4>
        <div id="debugContent"></div>
    </div>

    <script type="module">
        let inputManager = null;
        let canvas = null;
        let ctx = null;
        let animationId = null;

        // Test character
        const character = {
            x: 400,
            y: 300,
            width: 30,
            height: 30,
            vx: 0,
            vy: 0,
            grounded: true,
            color: '#ff6b35'
        };

        async function initTest() {
            try {
                // Get canvas
                canvas = document.getElementById('testCanvas');
                ctx = canvas.getContext('2d');

                // Import and create InputManager
                const { InputManager } = await import('./src/core/InputManager.js');
                inputManager = new InputManager(canvas);

                document.getElementById('status').innerHTML = '‚úÖ InputManager initialized successfully!';
                document.getElementById('status').className = 'status success';

                // Start test loop
                startTestLoop();

                // Enable debug info
                setTimeout(() => {
                    document.getElementById('debugInfo').style.display = 'block';
                }, 2000);

            } catch (error) {
                console.error('Failed to initialize test:', error);
                document.getElementById('status').innerHTML = '‚ùå Failed to initialize: ' + error.message;
                document.getElementById('status').className = 'status error';
            }
        }

        function startTestLoop() {
            let lastTime = performance.now();

            function gameLoop(currentTime) {
                const dt = currentTime - lastTime;
                lastTime = currentTime;

                // Update InputManager
                inputManager.update();

                // Update character based on input
                updateCharacter(dt);

                // Render
                render();

                // Update debug info
                updateDebugInfo();

                animationId = requestAnimationFrame(gameLoop);
            }

            gameLoop(performance.now());
        }

        function updateCharacter(dt) {
            const speed = 200; // pixels per second
            const jumpForce = 400;
            const gravity = 800;
            const friction = 0.8;

            // Horizontal movement - test input responsiveness
            if (inputManager.isKeyPressed('left')) {
                character.vx = -speed;
                character.color = '#4ecdc4'; // Visual feedback for left
            } else if (inputManager.isKeyPressed('right')) {
                character.vx = speed;
                character.color = '#ff6b35'; // Visual feedback for right
            } else {
                character.vx *= Math.pow(friction, dt / 16);
                character.color = '#ffaa00'; // Neutral color
            }

            // Jump - test action input responsiveness
            if (inputManager.isKeyPressed('jump') && character.grounded) {
                character.vy = -jumpForce;
                character.grounded = false;
                inputManager.clearJumpBuffer();
                character.color = '#ff4444'; // Visual feedback for jump
            }

            // Crouch - test continuous input
            if (inputManager.isKeyPressed('crouch') && character.grounded) {
                character.height = 15; // Visual feedback for crouch
                character.color = '#9944ff';
            } else {
                character.height = 30;
            }

            // Physics
            if (!character.grounded) {
                character.vy += gravity * dt / 1000;
            }

            // Update position
            character.x += character.vx * dt / 1000;
            character.y += character.vy * dt / 1000;

            // Boundaries and ground collision
            character.x = Math.max(character.width/2, Math.min(canvas.width - character.width/2, character.x));

            if (character.y > canvas.height - character.height/2 - 50) {
                character.y = canvas.height - character.height/2 - 50;
                character.vy = 0;
                character.grounded = true;
            }
        }

        function render() {
            // Clear canvas
            ctx.fillStyle = '#2a2a3e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Draw ground
            ctx.fillStyle = '#333';
            ctx.fillRect(0, canvas.height - 50, canvas.width, 50);

            // Draw character
            ctx.fillStyle = character.color;
            ctx.fillRect(
                character.x - character.width/2,
                character.y - character.height/2,
                character.width,
                character.height
            );

            // Draw input indicators
            drawInputIndicators();
        }

        function drawInputIndicators() {
            if (!inputManager) return;

            const indicatorY = 30;
            const indicatorSize = 20;
            let x = 30;

            // Left arrow
            ctx.fillStyle = inputManager.isKeyPressed('left') ? '#4ecdc4' : '#555';
            ctx.fillRect(x, indicatorY, indicatorSize, indicatorSize);
            ctx.fillStyle = 'white';
            ctx.font = '12px monospace';
            ctx.fillText('‚óÑ', x + 6, indicatorY + 14);
            x += indicatorSize + 10;

            // Right arrow
            ctx.fillStyle = inputManager.isKeyPressed('right') ? '#4ecdc4' : '#555';
            ctx.fillRect(x, indicatorY, indicatorSize, indicatorSize);
            ctx.fillStyle = 'white';
            ctx.fillText('‚ñ∫', x + 6, indicatorY + 14);
            x += indicatorSize + 10;

            // Jump
            ctx.fillStyle = inputManager.isKeyPressed('jump') ? '#ff4444' : '#555';
            ctx.fillRect(x, indicatorY, indicatorSize, indicatorSize);
            ctx.fillStyle = 'white';
            ctx.fillText('‚ñ≤', x + 6, indicatorY + 14);
            x += indicatorSize + 10;

            // Crouch
            ctx.fillStyle = inputManager.isKeyPressed('crouch') ? '#9944ff' : '#555';
            ctx.fillRect(x, indicatorY, indicatorSize, indicatorSize);
            ctx.fillStyle = 'white';
            ctx.fillText('‚ñº', x + 6, indicatorY + 14);
        }

        function updateDebugInfo() {
            if (!inputManager) return;

            const debugInfo = inputManager.getDebugInfo();
            const activeKeys = Object.keys(debugInfo.keys).filter(key => debugInfo.keys[key]);

            document.getElementById('debugContent').innerHTML = `
                <p><strong>Active Keys:</strong> ${activeKeys.length ? activeKeys.join(', ') : 'None'}</p>
                <p><strong>Mobile Device:</strong> ${debugInfo.mobile ? 'Yes' : 'No'}</p>
                <p><strong>Touch Controls:</strong> ${debugInfo.touchEnabled ? 'Enabled' : 'Disabled'}</p>
                <p><strong>Jump Buffered:</strong> ${debugInfo.jumpBuffered ? 'Yes' : 'No'}</p>
                <p><strong>Input History:</strong> ${debugInfo.historyLength} frames</p>
                <p><strong>Character Position:</strong> (${Math.round(character.x)}, ${Math.round(character.y)})</p>
                <p><strong>Character Velocity:</strong> (${Math.round(character.vx)}, ${Math.round(character.vy)})</p>
                <p><strong>Grounded:</strong> ${character.grounded ? 'Yes' : 'No'}</p>
            `;
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
            if (inputManager) {
                inputManager.destroy();
            }
        });

        // Initialize test
        initTest();
    </script>
</body>
</html>